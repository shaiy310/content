commonfields:
  id: HashiCorp Vault
  version: -1
name: HashiCorp Vault
display: HashiCorp Vault
category: Authentication
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAF8ElEQVRo3tVaa2wUVRQ+lUeolLZQHwQxEUIi/GgpakvTst2d7fax7RaEUFOIRW2x7e7cme220BawNSQ1MQZFgYaH8gvlFVAxUYIIJPxRA7FSLCpBJMYnL5FEyh8cvzttodvd6e527izpJCezO3Pn3Pvde853zzkzRKKPAmUOScp+Kg/MoVF7FCiZJLHz5JA1nL8jlzxzxLoklgw908iBc5xBZKPTSzqIAcmvPU3Ltk+NSc/S5vGUz9YASBd0XIXOb2jpKm+cQDAnOvw9CAQXm1ej0ubj9PW5yVHpaXplLJU3bKN83xA9+F+gtJAnkGAdCIm50dm1EBADYgeYrJrDlF0d2UTscj7ZfXcMdN2kJW2PWwPCIZdC/jYEESwHATopwsquHVZHgb9IPAinvhI3owTRJ5L8ITm8xisjye8N+7xLtQk2JyUHPnElJhB3CcB7hCpff9TATI8bPmfzXUCfqeJAuPyzoPinEYEYkMKGr8jtnztkhbmZ3gr1MYiTXaPFgWKRFDuenMpBUyD0wemsBGqVt2EVWmgRmMoh3wjTthdAdlGpP120cz8EO/7FNJBQswm95mR7qKTBoujAqUzADJ4QDiREWDe5lInWbn5FgWysyiEAOmNgDuZFkt+N107+AGw3hUrU6VSsLsTvo4LBHMFEJVDcD7syBh1vEQikFz5SRPflkNRU2PY5cebF/oBPLjM/sMWBVEShKpRuJxeLjsMdyibx/sL2UUXHCNmrtiUZ9n/0bhSaW3uL1A2RuVxiqy1ismvQvR7ycKxx1GuUP0hRdo1GLVvfjsK8NlpMzRdhbowKlSmRQVSumg/kt4csr0Y5dZepyvuEMXh/Ctr1kA1t56vDC28jmaLnbkQZ9VSoJhqxzzh08rmhguyXPqI9xxINzOotPsDkhbXavMZlWmZgeVjh93gbHYx5//kWYFZQkfLg0P2hAg3+M3xwQb1GFe0nacVaDz3XOB3m9xiU5UP64i/M9rzG5dq+6xnanqsZ2u4rc4OEX+P3eBt9ZYQRgnf/4IAwERe7IsyARnl1PBTX9IRKYteD7mNwfNb5gD+4nKG9/9fcIOHX+D3eRggQbp42Pp616wYBUVeaVtwPhM8+H/iuPzODhF/j94QB4RNaFviR1h1K6wPxYkcyZvqHUQckC2y6utN3bzWatzDKqtZGHZDcuh56oWNSH4h3dqRRSdP5frsfXUAkVn1vNTxyO+V5zfG6GGe/ohMIn1BOKFJEej5NBfKEwfHRAWE0OBL6ldh+0H4ussRpOqVXrfFQRdtJneqN+7qD+G9J8N7hbkzEalRBusynrDFuiE7lzbCbK990s6s/Ns732WGkweMMQgxs95JSB0BnzPF61CHKWVC+cY1rZWAG5fmuhs1Vlq96JprsbzLyZRmoL1gaADrZGxHHsiSwKagwwUtDLmV9rBEwKiasvb9sY0FezgIRx/BsUybCoN5Bz32G2CppZLlJTfNssrO94sEoG6MrCLIytN8KS/EB/CQBNS1WCflNIJgeOHvKfcrLlULd2YT5ibwZ5zHxB+JAicbBjgg1MV5KcjcuIk/TdFBrKnwzTsCcyk6LmIynBd04f0Lu1qctNi05CZ2dtbxkKiknyNmQaA0Il5qOTkLDmZyXrQDzMyRNLACPmgmlu+Ebt0MTG991Yhs6sUM34n6nvufYTfsMJ4G9VMjGigNR0+LRbTf84P4lW31wWdOtZlCx8qUpMPw9fZEyUxyI1rYpCA8uGQ5Kkr8I+5y39RFa4Ds8QiCXwVpZYk2q1C9FeIexw/BZm5yMmY01PbgBJ7egcF3oLxnWjl1Kc4Ty6USAPRBDSbTYGpZqacMGJf8TvnqBxEaS8yLqyKpJhnyqfzRgHPrzzzQsfIWweE0CuHw12euHMpVG5f7N+Nwiuh2Yf77hbj6mf84Rap6/YoO1x2cnL3m1Dp2e0h1RwtkuB5CSxhZGPL9zKj4UONX/NncAxEWS/E/FOcaSJ+mfHDlNhNFlrTP0l5x9weL38LF0GrWHq2m2/uLGpT4pWvX/zRDqQjZWrVoAAAAASUVORK5CYII=
description: Manage Secrets and Protect Sensitive Data through HashiCorp Vault
configuration:
- display: Server URL (e.g. https://192.168.0.1:8200)
  name: server
  defaultvalue: ""
  type: 0
  required: false
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: false
- display: Authentication token
  name: token
  defaultvalue: ""
  type: 0
  required: false
- display: Trust any certificate (unsecure)
  name: unsecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |-
    import requests
    import json
    import hcl

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    if not demisto.params().get('proxy', False):
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']


    CREDENTIALS = demisto.params().get('credentials', {})
    USERNAME = CREDENTIALS.get('identifier')
    PASSWORD = CREDENTIALS.get('password')
    VERIFY_SSL = not demisto.params().get('unsecure', False)
    TOKEN = demisto.params().get('token')

    def get_server_url():
        url = demisto.params()['server']
        url = re.sub('/[\/]+$/', '', url)
        url = re.sub('\/$', '', url)
        return url


    BASE_URL = get_server_url()
    SERVER_URL = BASE_URL + '/v1'

    def get_headers():
        headers =  {
            'Content-Type': 'application/json',
        }

        if TOKEN:
            headers['X-Vault-Token'] = TOKEN

        return headers

    def login():
        path = 'auth/userpass/login/' + USERNAME
        body = {
            'password': PASSWORD
        }

        url = '{}/{}'.format(SERVER_URL, path)
        res = requests.request('POST', url, headers=get_headers(), data=json.dumps(body), verify=VERIFY_SSL)
        if res.status_code < 200 or res.status_code >= 300:
            return_error('Got status code ' + str(res.status_code) + ' with url ' + url + ' with body ' + res.content + ' with headers ' + str(res.headers))

        auth_res = res.json()
        if not auth_res or 'auth' not in auth_res or 'client_token' not in auth_res['auth']:
            return_error('Could not authenticate user')

        return auth_res['auth']['client_token']

    def send_request(path, method = 'get', body=None, params=None, headers=None):
        body = body if body is not None else {}
        params = params if params is not None else {}

        url = '{}/{}'.format(SERVER_URL, path)

        headers = headers if headers is not None else get_headers()
        res = requests.request(method, url, headers=headers, data=json.dumps(body), params=params, verify=VERIFY_SSL)
        if res.status_code < 200 or res.status_code >= 300:
            return_error('Got status code ' + str(res.status_code) + ' with url ' + url + ' with body ' + res.content + ' with headers ' + str(res.headers))
        return res.json()


    def list_secrets_engines_command():
        res = list_secrets_engines()

        if not res:
            return 'No engines found'

        mapped_engines = [{
            'Path': k,
            'Type': v.get('type'),
            'Description': v.get('description'),
            'Accessor': v.get('accessor')
        } for k,v in res.get('data', {}).iteritems()]

        headers = ['Path', 'Type', 'Description', 'Accessor']

        demisto.results({
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('HashiCorp Vault Secrets Engines', mapped_engines, headers=headers, removeNull=True),
            'EntryContext': {
                  'HashiCorp.Engine(val.Path===obj.Path)': createContext(mapped_engines)
            }
        })

    def list_secrets_engines():
        path = 'sys/mounts'

        return send_request(path)

    #def get_secret_metadata_command():

    #def get_secret_metadata(engine_path, secret_name):


    def list_secrets_command():
        engine = demisto.args()['engine']

        res = list_secrets(engine)

        if not res or 'data' not in res:
            return_error('Engine not found')

        mapped_secrets = [{
            'Name': k
        } for k in res['data'].get('keys', [])]

        demisto.results({
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('HashiCorp Vault Secrets in engine path: ' + engine, mapped_secrets, removeNull=True),
            'EntryContext': {
                  'HashiCorp.Secret(val.Name===obj.Name)': createContext(mapped_secrets)
            }
        })

    def list_secrets(engine_path):
        path = engine_path

        params = {
            'list': 'true'
        }

        return send_request(path, 'get', params=params)

    def list_policies_command():
        res = list_policies()

        if not res or 'policies' not in res:
            return_error('No policies found')

        mapped_policies = [{
            'Name': i
        } for i in res['policies']]

        demisto.results({
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('HashiCorp Vault Policies', mapped_policies, removeNull=True),
            'EntryContext': {
                  'HashiCorp.Policy(val.Name===obj.Name)': createContext(mapped_policies)
            }
        })

    def list_policies():
        path = '/sys/policy'

        return send_request(path, 'get')

    def get_policy_command():
        name = demisto.args()['name']

        res = get_policy(name)

        if not res or 'rules' not in res:
            return_error('Policy not found')

        rules = hcl.loads(res['rules'])

        mapped_rules = [{'Path': k, 'Capabilities': v['capabilities']} for k,v in rules.get('path', {}).iteritems()]

        mapped_policy = {
            'Name': res['name'],
            'Rule': mapped_rules
        }

        demisto.results({
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('HashiCorp Vault Policy - ' + name, mapped_rules, removeNull=True),
            'EntryContext': {
                  'HashiCorp.Policy(val.Name===obj.Name)': createContext(mapped_policy)
            }
        })


    def get_policy(policy_name):
        path = 'sys/policy/' + policy_name

        return send_request(path, 'get')


    if USERNAME and PASSWORD:
        TOKEN = login()
    elif not TOKEN:
        return_error('Either an authentication token or user credentials must be provided')

    if demisto.command() == 'test-module':
        path = 'sys/health'
        send_request(path)
        demisto.results('ok')
    elif demisto.command() == 'fetch-incidents':
        sys.exit(0)
    elif demisto.command() == 'hashicorp-list-secrets-engines':
        list_secrets_engines_command()
    elif demisto.command() == 'hashicorp-list-secrets':
        list_secrets_command()
    elif demisto.command() == 'hashicorp-list-policies':
        list_policies_command()
    elif demisto.command() == 'hashicorp-get-policy':
        get_policy_command()
    # You can use demisto.args()[argName] to get a specific arg. args are strings.
    # You can use demisto.params()[paramName] to get a specific params.
    # Params are of the type given in the integration page creation.
  type: python
  commands:
  - name: hashicorp-list-secrets-engines
    arguments: []
    outputs:
    - contextPath: HashiCorp.Engine.Type
      description: Secrets engine type
      type: string
    - contextPath: HashiCorp.Engine.Path
      description: Secrets engine path in HashiCorp
      type: string
    - contextPath: HashiCorp.Engine.Description
      description: Secrets engine description
      type: string
    - contextPath: HashiCorp.Engine.Accessor
      description: Secrets engine accessor
      type: string
    description: List all secrets engine types that exist in HashiCorp Vault.
  - name: hashicorp-get-secret-metadata
    arguments:
    - name: name
      required: true
      description: Secret name
    - name: path
      required: true
      description: KV Engine path (engine path - for example - /kv)
    outputs:
    - contextPath: HashiCorp.Secret.Created
      description: Secret created time
      type: date
    - contextPath: HashiCorp.Secret.State
      description: Destroyed - true or false
      type: boolean
    - contextPath: HashiCorp.Secret.Version
      description: Version amount
      type: number
    - contextPath: HashiCorp.Secret.DeletedTime
      description: If deleted - returns deleted time
      type: date
    - contextPath: HashiCorp.Secret.UpdatedTime
      description: Secret's last updated time
      type: date
    - contextPath: HashiCorp.Secret.Engine
      description: Secrets engine type
      type: string
    description: Get information about a specified secret in a specified K/V V2 engine
  - name: hashicorp-list-secrets
    arguments:
    - name: engine
      required: true
      description: Engine path  (for example - kv/)
    outputs:
    - contextPath: HashiCorp.Secret.Name
      description: Secret name
      type: string
    - contextPath: HashiCorp.Secret.Path
      description: Secrets engine path in HashiCorp
      type: string
    - contextPath: HashiCorp.Secret.Engine
      description: Secrets engine type
      type: string
    description: List secrets (names) for a specified engine
  - name: hashicorp-delete-secret
    arguments:
    - name: name
      required: true
      description: Secret name
    - name: path
      required: true
      description: Secret's path (engine path - for example - /kv)
    outputs:
    - contextPath: HashiCorp.Secret.Name
      description: Secret name
      type: string
    - contextPath: HashiCorp.Secret.Path
      description: Secrets engine path in HashiCorp
      type: string
    - contextPath: HashiCorp.Secret.Engine
      description: Secrets engine type
      type: string
    - contextPath: HashiCorp.Secret.State
      description: Secret's state
      type: string
    description: Deletes the data under a specified secret given the secret path.
      Performs a soft delete that allows the undelete command if necessary
  - name: hashicorp-undelete-secret
    arguments:
    - name: name
      required: true
      description: Secret name
    - name: path
      required: true
      description: Secret's path (engine path - for example - /kv)
    outputs:
    - contextPath: HashiCorp.Secret.Name
      description: Secret name
      type: string
    - contextPath: HashiCorp.Secret.Path
      description: Secrets engine path in HashiCorp
      type: string
    - contextPath: HashiCorp.Secret.Engine
      description: Secrets engine type
      type: string
    - contextPath: HashiCorp.Secret.State
      description: Secret's state
      type: string
    description: Undelete a secret on HashiCorp
  - name: hashicorp-destroy-secret
    arguments:
    - name: name
      required: true
      description: Secret name
    - name: path
      required: true
      description: Secret's path (engine path - for example - /kv)
    outputs:
    - contextPath: HashiCorp.Secret.Name
      description: Secret name
      type: string
    - contextPath: HashiCorp.Secret.Path
      description: Secrets engine path in HashiCorp
      type: string
    - contextPath: HashiCorp.Secret.Engine
      description: Secrets engine type
      type: string
    - contextPath: HashiCorp.Secret.State
      description: Secret's state
      type: string
    description: Destroy a secret - delete permanently
  - name: hashicorp-disable-secrets-engine
    arguments:
    - name: path
      required: true
      description: Secrets engine path
    outputs:
    - contextPath: HashiCorp.Engine.Type
      description: Secrets engine type
      type: string
    - contextPath: HashiCorp.Engine.Path
      description: Secrets engine path in HashiCorp
      type: string
    - contextPath: HashiCorp.Engine.State
      description: Enabled or Disabled
      type: string
    description: When a secrets engine is no longer needed, it can be disabled. All
      secrets under the engine are revoked and the corresponding Vault data and configuration
      is removed.
  - name: hashicorp-list-policies
    arguments: []
    outputs:
    - contextPath: HashiCorp.Policy.Name
      description: Policy name
      type: string
    description: List all configured policies.
  - name: hashicorp-run-cli-command
    arguments:
    - name: command
      required: true
      description: HashiCorp CLI command
    outputs:
    - contextPath: HashiCorp.CLI.Output
      description: CLI Command output
      type: string
    description: https://www.vaultproject.io/docs/commands/index.html
  - name: hashicorp-seal-vault
    arguments: []
    outputs:
    - contextPath: HashiCorp.Key
      description: Unseal key
      type: string
    - contextPath: HashiCorp.Root.Token
      description: Initial root token
      type: string
    description: If you suspect your data has been compromised, you can seal your
      vault to prevent access to your secrets
    execution: true
  - name: hashicorp-unseal-vault
    arguments:
    - name: keys
      required: true
      description: Unsealing keys separated by comma
    - name: root_token
      required: true
      description: Authenticate as the initial root token
    outputs:
    - contextPath: HashiCorp.State
      description: Vault state (sealed/unsealed)
      type: string
    description: 'Unseal HashiCorp vault that has been sealed '
  - name: hashicorp-create-authentication
    arguments:
    - name: read
      description: 'Accepts paths the token will have READ access to. Can accept more
        than one path, separated by comma. (for example: secret/*)'
    - name: create
      description: 'Accepts paths the token will have CREATE access to. Can accept
        more than one path, separated by comma. (for example: secret/*)'
    outputs:
    - contextPath: HashiCorp.Token
      description: Authentication token
    description: Create an authentication policy and receive an authentication token.
  - name: hashicorp-get-policy
    arguments:
    - name: name
      required: true
      description: Policy name
    outputs:
    - contextPath: HashiCorp.Policy.Name
      description: Policy name
      type: string
    - contextPath: HashiCorp.Policy.Path
      description: Policy path
      type: string
    - contextPath: 'HashiCorp.Policy.Path.Capabilities '
      description: Policy capabilities for a path
    description: Get a policy with a specified name
  dockerimage: blob
  runonce: false
releaseNotes: "-"