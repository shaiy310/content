commonfields:
  id: Netskope
  version: -1
name: Netskope
display: Netskope
category: Network Security
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAyCAMAAACgee/qAAABs1BMVEUAAABXV1wKDhNVVVpVVVVVVVlWVlZVVVpVVVpTU1tUVFhUVFdXV1dVVVlUVFlOTlZTU1dLS1BWVltUVVpVVVlUVFdTU1dVVVlUVFlTU1hUVFZTU1VLS1IAqdNVVVpVVVpVVVpLS0tVVVpUVFVPT08uLkRVVVlUVFpTU1hVVVpVVVlSUldVVVtQUFJTU1lUVFdVVVlUVFlUU1hUVFhSUllSUlRUVFpUVFpUVFlUVFlUVFlUU1hUVFlUVFpTU1dVVVpUVFdRUVV1V1lUVFhVVVhUVFf4gABUVFr3cwAAqNH1fwBRUlpQUFZISFFGRlgAqdIAqNJVVVVLS1kApM1GRlgApdQAqdH1fgD1fgAAqNEAp9EAqNIAqdP1fAAAp9AAp88AospOTlnzeQBDQ14AocoAp9H7gQAAqNL4fgBcS0v0fQAAqNIAp9AAp8/0fQD1fgAAps9BZnH1fwAApc4ApMu/bSEAp88ApcoAver3gAD4gQBOU11NVF4Ap9D0fwD1fwDyfgD0fQD0fgD0egBKSltWVltZWV5YWF1bW2D2gAAAq9UArtj6ggD9gwD4gAAAsdxdXWIL5SRVAAAAhXRSTlMA/gLbHOQL/fo3jokX6LkgcQj47tdgQs/HbUoRDv304MsGwikUCfCPhOu9PC0jk0W0p3pkWyf259OimlSwq3VZUTUFfWlN+Z8V7X5HMhkW5towKyYdEfTk2M6mhoBtaV9VLiITBsa0l46NjXx3b1xVSkpHQjs5MhgL7NDOybmpnWFgXy4teju0XQAABgJJREFUWMPclMlr20AUxt+4i5NAaBwjt6kZpyFQN6EE4ranGJemVEgqrQ1uvG+Y7Pue7tlQJpqR5H85EpYUE3zJ4V3yuwz8Lh/fzLwHD5DJsTcjn+64fKO2eRgCTOZTU+yKJZJPe2UjKzqdwsoCIDJCiK7rhCV7+jWpKJSzQlQWAY1nT5juQhK3t32S6+QOFvIVTluAxpzuwTKBO6C06b5zlv8DNN4xP3gocC1eOHaOxSWRAzS+hv3gdOA2BN9yjmOVVwAL5eiPV5kMf/DczyXB1UZ+tyzUQ0AitL78Meols9lIV25SSjlXqeA1QKK9Kturc38HCHPDyeyk27dKHbgQNLeFMk2X9fX/RdMwzOWjmJSaDhOn83A6mdmrqZzycrW5ewIIzGu/TMuyDcOWNQUAIlKUuGvkir1ea2VpFW1naaZT1sXUPCONep+MrW2sABbtop9bUjwVmfYnOrGHt6O3baOLdRq4z8Sf6BSgUbf8YC1wUhA8A2js+I3ts8DFBm63NhpKqVvZLLYDF3/FurlTbwGPbdlNtuR6j3sZZW5uOAOY7PyWbbl0HoLe5BejJPxobAJQUfYv9pU7Lh6TvnyDe/M93ldP/ECu8Ph5OtLPvx+XAJVBfbzvNQ1dzwAqgzfdlttu2kAQhtcnTBKMwTbEBoQdc8bhDOUUCoFEXKSNlCovUOVV6tm97CN37bVdWiH1oqpadW5YZtfz7c7+M3ZayJzzX5HWj47/Cfx8Hnz5m5GZ3ie73omg1tbEayTgXqVciSYeJ9uLyk/g3gUr24o3sba3bMwmdtbD00m6GnTBWkWJ8VNHBsDzVh2xAAcbA6S7xQicFgzBCCS8twQO4J1plU/B94vqhyDK1qRRQB+9IGavfQkDcEYuFTm8bJpipHYlBj9oYG9G9LFh6CpvQO72lzbo6xCscdVqtTkOFvq+ORpKQA4n4KJNHJGW9RUHwmiVrRKpFPpnDsjuarnAeMMOtO6Avex3ZdhE5JoES3r+VKGJrWDnlyCtaW9QRyDNArBse7UvNZr4uuGPG4h/tdz1d/DjHNzgknJYO2Qo33NB+hykrUvsXZ4+9L4Kqz11vCgh5matQJuB+3jBttQGk668r2o7dvEmabE7rkc7rOoia1ooARd0uMsEcwoXvQQ+OmREF0y5ZpE5cuk0zQG/JEOW8wlWauFAgstYRopK8WR4E7/CjfJpOb1KXIsNYzBvaXgVJm4MTnyVO03/hPgROcaSMsmSR72ONoj+X2N25HdcjnnUefMW3WQhh2alwWBQnGjVz6dgvo1B6O/E7+CcprXz4dQdaSclIuApajh4GzsOsCijkiyUU8VBEDeLjR/BokLBKQfvUteYo+Zj2TsFo/x7ARPO7s/iBjIk0ic2Y0LSufddkkOphf8UO7ZYUlEBXPTAceyD890ZcMOE6f6qmw1tVU/A0ZLp0eCIcB+d+GUB17Xw1l14CH7ZmFgode2XYkcBJBFNwbzxhllm1hkwvyFXNHVh/s62zOepAXf7SFwfDELJoXSOyeYkrkTBkIsdLUJF68lKD/FxdzkDRhYYMajBh+X0c68ucfZHBg7JTi84FVY+RdMWFjIB2E1FYYWgfsoGWHHDyp8F03UrNvPovA9Ca0rU5YqtF+b3jXIETshvDmQzbNUcxoiCsd/mw90fQaqFupe8cMHbyu2dA6Ophu8GmeeLy2oYum5Af6YW6W0fv3ZaRVXcGeSST8DoXiAmDTTQwdmqb7fjDhlWQjCWj1498zTEWiEUu0uk3KyuTs1YkTKOy6lDy4fapENkSdJIul8JOyoHTT0ovduhT2Rd94krBuL62kcxecPTPAiAO3YVuM1HFIDljU7S0twnyoRn4bMATVvHZBF1lqEd6a/SNZ9ZqJXR6QijEs9UWnDnUvjGyJdW1/O5cwhz+uQ+xi9Od8wHgduOott32zxi4IG3FPTOopV8TlceunNdMQ9iLCE11lo9UVF5NqvHXgoUxXw0TIliKvYilIgwmlRrGTaMyqk+6wVJOwlUUxvojxoD/9r+H3Bl8ZfAja52gf6K1Yp79E/aN/cOdSx4Lr2hAAAAAElFTkSuQmCC
description: Netskope Platform Integration
detaileddescription: 'You can grab the API token from your Netskope tenant by navigating
  to: Settings-->Manage-->REST API'
configuration:
- display: URL of Netskope Tenant (e.g. tenant.goskope.com)
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Tenant API Token
  name: token
  defaultvalue: ""
  type: 0
  required: true
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
script:
  script: |-
    var SERVER_URL = params.url.replace(/[\/]+$/, '');
    var BASE_URL = SERVER_URL + '/api/v1/';
    var TOKEN = params.token;

    function sendRequest(method, api) {
        var requestUrl = "https://" + BASE_URL + api;
        var result = http(
            requestUrl,
            {
                Method: method,
                Headers: {
                    'Content-Type': ['application/json'],
                    'Accept': ['application/json']
                }
            },
            params.insecure,
            params.proxy
            );
        if (result.StatusCode < 200 && result.StatusCode > 299) {
            throw 'Failed to perform request ' + path + ', request status code: ' + result.StatusCode + ', body: ' + result.Body;
        }
        if (result.Body === '') {
            throw 'No content received.' + requestUrl + result.Body;
        }
        var body;
        try {
            body = JSON.parse(result.Body);
        } catch (ex) {
            throw 'Error parsing reply - ' + result.Body + ' - ' + ex;
        }
        return body;
    }

    function normalizeTimestamp(timestamp) {
        return Date(timestamp);
    }

    function getAlerts() {
        var queryArgs = {
            token: TOKEN,
            type: encodeURIComponent(args.type)
        };
        if (!args.timeperiod && !args.query) {
            queryArgs.starttime = args.starttime;
            queryArgs.endtime = args.endtime;
        } else if (!args.timeperiod && !args.query) {
            queryArgs.starttime = args.starttime;
            queryArgs.endtime = args.endtime;
            queryArgs.query = encodeURIComponent(args.query);
        } else if (!args.query) {
            if (!args.timeperiod) {
                queryArgs.starttime = args.starttime;
                queryArgs.endtime = args.endtime;
            } else {
                queryArgs.timeperiod = args.timeperiod;
            }
        } else if (args.query && args.timeperiod) {
            queryArgs.timeperiod = args.timeperiod;
            queryArgs.query = encodeURIComponent(args.query);
        } else {
            throw 'Not given enough arguments to filter events by.'
        }

        var cmdUrl = 'alerts' + encodeToURLQuery(queryArgs);
        var result = sendRequest('GET', cmdUrl);
        var retArray = [];
        result.data.forEach(function(arrayItem) {
            var app =  arrayItem.app;
            var timestamp =  normalizeTimestamp(arrayItem.timestamp);
            var dlp_profile =  arrayItem.dlp_profile;
            var dlp_file =  arrayItem.dlp_file;
            var hostname =  arrayItem.hostname;
            var policy =  arrayItem.policy;
            retArray.push({"App" : app, "Timestamp" : timestamp, "DLPProfile" : dlp_profile, "DLPFile" : dlp_file, "Hostname" : hostname, "Policy" : policy})
        });
        var ec = {
            "Netskope.Alerts" : retArray
        };
        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: retArray,
            ReadableContensFormat: formats.markdown,
            HumanReadable: tableToMarkdown('Netskope alerts', retArray),
            EntryContext: ec
        };
    }

    function getEvents() {
        var queryArgs = {
            token: TOKEN,
            type: encodeURIComponent(args.type)
        };
        if (!args.timeperiod && !args.query) {
            queryArgs.starttime = args.starttime;
            queryArgs.endtime = args.endtime;
        } else if (!args.timeperiod && !args.query) {
            queryArgs.starttime = args.starttime;
            queryArgs.endtime = args.endtime;
            queryArgs.query = encodeURIComponent(args.query);
        } else if (!args.query) {
            if (!args.timeperiod) {
                queryArgs.starttime = args.starttime;
                queryArgs.endtime = args.endtime;
            } else {
                queryArgs.timeperiod = args.timeperiod;
            }
        } else if (args.query && args.timeperiod) {
            queryArgs.timeperiod = args.timeperiod;
            queryArgs.query = encodeURIComponent(args.query);
        } else {
            throw 'Not given enough arguments to filter events by.'
        }

        var cmdUrl = 'events' + encodeToURLQuery(queryArgs);
        var result = sendRequest('GET', cmdUrl);
        var retArray = [];
        result.data.forEach(function(arrayItem) {
            var app =  arrayItem.app;
            var timestamp = normalizeTimestamp(arrayItem.timestamp);
            var activity =  arrayItem.activity;
            var object =  arrayItem.object;
            var hostname =  arrayItem.hostname;
            var category =  arrayItem.category;
            var device_classification =  arrayItem.device_classification;
            var user =  arrayItem.user;
            var from_user =  arrayItem.from_user;
            var to_user =  arrayItem.to_user;
            var srcip =  arrayItem.srcip;
            var access_method =  arrayItem.access_method;
            var url =  arrayItem.url;
            retArray.push({"App" : app, "Timestamp" : timestamp, "Activity" : activity, "Object" : object, "Hostname" : hostname, "AppCategory" : category, "DeviceClassification" : device_classification, "User" : user, "FromUser" : from_user, "ToUser" : to_user, "SourceIP" : srcip, "AccessMethod" : access_method, "URL" : url});
        });
        var ec = {
            "Netskope.Events" : retArray
        };
        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: retArray,
            ReadableContensFormat: formats.markdown,
            HumanReadable: tableToMarkdown('Netskope Events', retArray),
            EntryContext: ec
        };
    }

    switch (command) {
        case 'test-module':
            var queryArgs = {
                token: TOKEN,
                type: 'application',
                timeperiod: '3600',
                limit: '1'
            };
            var cmdUrl = 'events' + encodeToURLQuery(queryArgs);
            result = sendRequest('GET', cmdUrl);
            if (result.status != "error") {
                return 'ok';
            }
            return result;
        case 'NetskopeEvents':
            return getEvents();
        case 'NetskopeAlerts':
            return getAlerts();
    }
  type: javascript
  commands:
  - name: NetskopeEvents
    arguments:
    - name: query
      description: filter query (e.g. user eq jtesarz@netskope.com)
    - name: timeperiod
      auto: PREDEFINED
      predefined:
      - "3600"
      - "86400"
      - "604800"
      - "2592000"
      - "5184000"
      - "7776000"
      description: TimePeriod
    - name: starttime
      description: start time in epoch
    - name: endtime
      description: end time in epoch
    - name: type
      required: true
      auto: PREDEFINED
      predefined:
      - application
      - page
      - audit
      description: Type of Event (e.g Application, Page, Audit)
    - name: limit
      description: Limit the number of events returned (useful for pagination in combination
        with skip). Positive integer less than 5000.
    - name: skip
      description: Skip over some of the events (useful for pagination in combination
        with limit)
    outputs:
    - contextPath: Netskope.Events.app
      description: Name of Application
    - contextPath: Netskope.Events.timestamp
      description: Timestamp of event
    - contextPath: Netskope.Events.activity
      description: Activity of event
    - contextPath: Netskope.Events.object
      description: Document/object from event
    - contextPath: Netskope.Events.hostname
      description: Hostname of device
    - contextPath: Netskope.Events.Category
      description: Netskope application category (e.g. Cloud Storage, Webmail, etc)
    - contextPath: Netskope.Events.device_classification
      description: Device classification (e.g. managed vs unmanaged)
    - contextPath: Netskope.Events.user
      description: User
    - contextPath: Netskope.Events.from_user
      description: Login IDs for cloud apps
    - contextPath: Netskope.Events.to_user
      description: Destination user IDs
    - contextPath: Netskope.Events.srcip
      description: Source IP
    - contextPath: Netskope.Events.access_method
      description: Access method (e.g. client, reverse proxy, Secure Forwarder, etc)
    - contextPath: Netskope.Events.url
      description: URL
    - contextPath: Netskope.Events.appcategory
  - name: NetskopeAlerts
    arguments:
    - name: type
      required: true
      auto: PREDEFINED
      predefined:
      - anomaly
      - Compromised Credential
      - DLP
      - Legal Hold
      - malsite
      - Malware
      - policy
      - quarantine
      - Remediation
      - watchlist
    - name: timeperiod
      auto: PREDEFINED
      predefined:
      - "3600"
      - "86400"
      - "604800"
      - "2592000"
      - "5184000"
      - "7776000"
      description: Time period (e.g. Last 60 minutes, Last 24 hours, etc.)
    - name: starttime
      description: Start time in epoch
    - name: endtime
      description: End time in epoch
    - name: query
      description: "Valid event query described in the query language document\t"
    outputs:
    - contextPath: Netskope.Events.app
      description: Name of Application
    - contextPath: Netskope.Events.timestamp
      description: Timestamp of event
    - contextPath: Netskope.Events.policy
      description: Name of Policy Triggered
    - contextPath: Netskope.Events.DLP_File
      description: Name of DLP File that triggered
    - contextPath: Netskope.Events.Hostname
      description: Hostname
    - contextPath: Netskope.Events.User
      description: Email of user
