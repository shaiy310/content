versionedfields: {}
commonfields:
  id: DomainTools
  version: -1
name: DomainTools
fromversion: 3.0.0
display: DomainTools
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Domain name, DNS and Internet OSINT-based cyber threat intelligence and
  cybercrime forensics products and data
configuration:
- display: DomainTools API URL
  name: server
  defaultvalue: http://api.domaintools.com/
  type: 0
  required: true
- display: API Username
  name: username
  defaultvalue: ""
  type: 0
  required: true
- display: API Key
  name: key
  defaultvalue: ""
  type: 4
  required: true
- display: Open authentication (less secure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |-
    var toCamelCase = function(string){
        var str = ' '+string.trim();
        str=str.replace(/ ([a-z,A-Z])/g, function (g) { return g[1].toUpperCase(); });
        return str;
    };

    var sendRequest = function(url) {
        var res = http(
            url,
            {
                Method: 'GET',
                Headers: {
                    Accept: ['application/json']
                }
            },
            params.insecure,
            params.proxy
        );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        try {
            return JSON.parse(res.Body);
        }
        catch (err) {
            throw 'Failed to parse JSON';
        }
    };

    var addKeyToJson = function(cur, toAdd){
        if(!cur){
            return toAdd;
        }
        if(!Array.isArray(cur)){
            return [cur, toAdd];
        }
        cur.push(toAdd);
        return cur;
    };

    var changeKeys = function(conv, obj){
        var output = {};
        for (var i in obj) {
            if (Object.prototype.toString.apply(obj[i]) === '[object Object]') {
                output[conv(i)] = changeKeys(conv, obj[i]);
            } else {
                output[conv(i)] = obj[i];
            }
        }
        return output;
    };

    var callWhoIs = function(query, parsed,url){
        var res = sendRequest(url + query + '/whois/parsed/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key}));
        var error = res.response.error;
        if(error && error.code === 206){
            parsed = false;
            log('error code 206');
        }
        var splitRes = res.response.whois.record.split('\n');
        var md = '### DomainTools whois result for '+ query + '\n';
        var resMap = {};
        splitRes.forEach(function(entry){
            splitEntry = entry.split(/:\s(.+)/);
            if(splitEntry[1]){
                splitEntry[0] = toCamelCase(splitEntry[0]);
                md += '**'+splitEntry[0]+':** '+splitEntry[1]+'\n';
                resMap[splitEntry[0]] = addKeyToJson(resMap[splitEntry[0]], splitEntry[1]);
            }
        });

        var context;
        if(parsed === 'false'){
            context = {'Domain': {'Name': res.response.record_source, 'Whois': resMap}};
        }else{
            context = {'Domain': {'Name': res.response.record_source, 'Whois': changeKeys(toCamelCase, res.response.parsed_whois)}};
        }

        return {
                Type: entryTypes.note,
                Contents: res,
                ContentsFormat: formats.json,
                ReadableContentsFormat: formats.markdown,
                HumanReadable: md,
                EntryContext: context
            };
    };

    var scoreConv = function(score, threshold){
        if(threshold){
            return score>=threshold ? 3 : 1;
        }
        if(score === 0)
            return 1;
        if(score > 0 && score <=69)
            return 2;
        if(score >= 70)
            return 3;
        return -1;
    };

    var callDomain = function(url, domain, threshold){
        var repRes = sendRequest(url + 'reputation/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key, 'domain' : domain}));
        var md = 'Domain '+repRes.response.domain+' found with risk score of '+ repRes.response.risk_score +'.';
        var context = {
            'DBotScore' : {
                'Indicator' : domain,
                'Score' : scoreConv(repRes.response.risk_score, threshold),
                'Type': 'domain',
                'Vendor': 'domaintools'
            }
        };
        if(context.DBotScore.Score === 3){
            addMalicious(context, outputPaths.domain, {'Name' : domain, 'RiskScore': repRes.response.risk_score ,'Malicious' : {'Vendor' : 'DomainTools'}});
        }

        return {
                Type: entryTypes.note,
                Contents: repRes,
                ContentsFormat: formats.json,
                HumanReadable: md,
                ReadableContentsFormat: formats.markdown,
                EntryContext: context
            };
    };

    var callProfile= function(url, domain){
        var domRes = sendRequest(url + domain + '/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key}));
        return {
                Type: entryTypes.note,
                Contents: domRes,
                ContentsFormat: formats.json
            };
    };

    var argToUrlParam = function(string){
        var map = {
            'exclude':'exclude_query',
            'maxLength':'max_length',
            'minLength':'min_length',
            'hesHyphen':'has_hyphen',
            'hasNumber':'has_number',
            'activeOnly':'active_only',
            'deletedOnly':'deleted_only',
            'anchorLeft':'anchor_left',
            'anchorRight':'anchor_right',
            'pageNumber':'page'
        };
        return map[string] ? map[string] : string;
    };

    var callDomainSearch = function(url, args){
        args = changeKeys(argToUrlParam,args);
        args.api_username = params.username;
        args.api_key = params.key;
        var res = sendRequest(url +  'domain-search/'+encodeToURLQuery(args));
        var results = res.response.results;

        var md = '';
        var numDomains = 0;
        var context = {'Domain' : []};
        if(results && results.length > 0){
            results.forEach(function(result){
                if(result.hashad_tlds && result.hashad_tlds.length > 0){
                    result.hashad_tlds.forEach(function(tld){
                        md+='* '+result.sld+'.'+tld+'\n';
                        numDomains++;
                        context.Domain.push({'Name' : result.sld+'.'+tld});
                    });
                }
            });
        }

        return {
                Type: entryTypes.note,
                Contents: res,
                ContentsFormat: formats.json,
                ReadableContentsFormat: formats.markdown,
                HumanReadable: 'Found '+numDomains +' domains:\n'+md,
                EntryContext: context
            };
    };

    var callReverseIP = function(url, args){
        var md = '';
        var context = {'Domain' : []};
        var res;
        var addresses;
        if(args.domain){
            res = sendRequest(url + args.domain+'/reverse-ip/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key, 'limit': args.limit? args.limit : 50}));

        }
        else if(args.ip){
            res = sendRequest(url + args.ip+'/host-domains/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key, 'limit': args.limit? args.limit : 50}));
        }
        addresses = res.response.ip_addresses;
        if(!Array.isArray(addresses)){
            addresses = [addresses];
        }

        addresses.forEach(function(address){
            md+= '\nFound ' + address.domain_count + ' domains for ' +address.ip_address + '\n';
            address.domain_names.forEach(function(domain){
                md += '* ' + domain + '\n';
                context.Domain.push({'Name': domain, 'DNS' : {'Address' : address.ip_address}});
            });
        });

        return {
            Type: entryTypes.note,
            Contents: res,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: md,
            EntryContext: context
        };
    }

    var callReverseNameServer = function(url, server, limit){
        var res = sendRequest(url +server + '/name-server-domains/' + encodeToURLQuery({'api_username':params.username,'api_key':params.key, 'limit': limit? limit : 50}));
        var md = 'Found ' +  res.response.primary_domains.length + ' domains\n';
        var context = {'Domain' : []};
        res.response.primary_domains.forEach(function(domain){
            md += '* ' + domain + '\n';
            context.Domain.push({'Name' : domain});
        });

        return {
            Type: entryTypes.note,
            Contents: res,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: md,
            EntryContext: context
        };
    }

    var callReverseWhoIs = function(url, args){
        args.api_username = params.username;
        args.api_key = params.key;
        args.mode = args.quoteMode;
        args.scope = 'current';
        if(args.onlyHistoricScope === 'true'){
            args.scope = 'historic';
        }
        delete args.quoteModel
        delete args.onlyHistoricScope;

        var res = sendRequest(url + encodeToURLQuery(args));
        var context = {'Domain' : []};
        var md = 'Found '+res.response.domains.length+ ' domains: \n';
        res.response.domains.forEach(function(domain){
            md += '* ' + domain + '\n';
            context.Domain.push({'Name' : domain});
        });

        return {
            Type: entryTypes.note,
            Contents: res,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: md,
            EntryContext: context
        };
    }

    /*http://api.domaintools.com/v1/domaintools.com/whois/history/*/
    var callWhoisHistory = function(url, domain){
        var res = sendRequest(url+domain+'/whois/history/'+ encodeToURLQuery({'api_username':params.username,'api_key':params.key}));
        var splitRecord;
        var context = {'Domain' : {'Name' : domain, 'WhoisHistory' : []}};
        var md = '';
        var entryContext, record;
        res.response.history.forEach(function(entry){
            entryContext = {};
            record = entry.whois.record;
            if(record){
                var splitRecord = record.split('\n');
                splitRecord.forEach(function(pair){
                    splitEntry = pair.split(/:\s(.+)/);
                        if(splitEntry[1]){
                            splitEntry[0] = toCamelCase(splitEntry[0]);
                            md += '**'+splitEntry[0]+':** '+splitEntry[1]+'\n';
                            entryContext[splitEntry[0]] = splitEntry[1];
                        }
                });
            }
            context.Domain.WhoisHistory.push(entryContext);
        });

        return {
            Type: entryTypes.note,
            Contents: res,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: md,
            EntryContext: context
        };
    }

    var url = params.server.replace(/[\/]+$/, '');
    switch (command) {
        case 'test-module':
                var res = sendRequest(url + '/v1/demisto.com/whois/parsed/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key}));
                if(res.response.error){
                    log('Something went wrong - error code ' + error.code);
                }
                return 'ok';
        case 'domain':
            return callDomain(url+'/v1/', args.domain, args.threshold);
        case 'domainSearch':
            return callDomainSearch(url+'/v2/', args);
        case 'reverseIP':
            return callReverseIP(url+'/v1/', args);
        case 'reverseNameServer':
            return callReverseNameServer(url+'/v1/', args.nameServer, args.limit);
        case 'reverseWhois':
            return callReverseWhoIs(url + '/v1/reverse-whois/', args);
        case 'whois':
            return callWhoIs(args.query, args.parsed, url+'/v1/');
        case 'whoisHistory':
            return callWhoisHistory(url+'/v1/', args.domain);
        case 'domainProfile':
            return callProfile(url+'/v1/', args.domain);
    }
  type: javascript
  commands:
  - name: domain
    arguments:
    - name: domain
      required: true
      description: Domain name to check reputation
    - name: long
      description: Should we return full response with detected URLs
    - name: sampleSize
      description: The number of samples from each type (resolutions, detections,
        etc.) to display for long format
    - name: threshold
      description: ' If number of positive detected domains is bigger than the threshold
        we will consider it malicious'
    - name: wait
      description: Wait time between tries if we reach the API rate limit in seconds
    - name: retries
      description: Number of retries for API rate limit
    outputs:
    - contextPath: Domain.Name
      description: The tested domain
    - contextPath: Domain.RiskScore
      description: The reputation returned from DomainTools
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: ' DBotScore.Vendor'
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Retrieve domain information.
  - name: domainSearch
    arguments:
    - name: query
      required: true
      default: true
      description: (mandatory and default) Query strings. Each term in the query string
        must be at least three characters long. Use spaces to separate multiple terms
    - name: pageNumber
      description: ' Sets the page of results to retrieve from the server. Each page
        is limited to 100 results. Default: 1'
      defaultValue: "1"
    - name: maxLength
      description: 'Limit the maximum domain character count. Default: 25'
      defaultValue: "25"
    - name: minLength
      description: 'Limit the minimum domain character count. Default: 1'
      defaultValue: "1"
    - name: hesHyphen
      description: ' (true or false) Return results with hyphens in the domain name.
        Default: true'
    - name: exclude
      description: ' Terms to exclude from matching'
    - name: activeOnly
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: ' (true or false) Return only domains currently registered.Default:
        false'
      defaultValue: "false"
    - name: deletedOnly
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: '(true or false) Return only domains previously registered but
        not currently registered. Default: false'
      defaultValue: "false"
    - name: anchorLeft
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: ' (true or false) Return only domains that start with the query
        term. Default: false'
      defaultValue: "false"
    - name: anchorRight
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: ' (true or false) Return only domains that end with the query term.
        Default: false'
      defaultValue: "false"
    - name: hasNumber
      auto: PREDEFINED
      predefined:
      - "false"
      - "true"
      description: '(true or false) Return results with numbers in the domain name.
        Default: true'
      defaultValue: "true"
    outputs:
    - contextPath: Domain.Name
      description: Domain found by command
    description: Search for domain based on the given parameters
  - name: reverseIP
    arguments:
    - name: ip
      default: true
      description: (default) specify IP address
    - name: domain
      description: ' If you provide a domain name, DomainTools will respond with the
        list of other domains that share the same IP'
    - name: limit
      description: Limits the size of the domain list than can appear in a response.
        The limit is applied per-IP address, not for the entire request.
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.DNS.Address
      description: IP address
    description: Reverse loopkup of an IP address
  - name: reverseNameServer
    arguments:
    - name: nameServer
      required: true
      default: true
      description: ' (default and mandatory) specify the name of the primary or secondary
        name server'
    - name: limit
      description: Limit the size of the domain list than can appear in a response
    outputs:
    - contextPath: Domain.Name
      description: Name of domain
    description: Reverse nameserver lookup
  - name: reverseWhois
    arguments:
    - name: terms
      required: true
      default: true
      description: ' (mandatory and default) List of one or more terms to search for
        in the Whois record, separated with the pipe character ( | ).'
    - name: exclude
      description: Domain names with Whois records that match these terms will be
        excluded from the result set. Separate multiple terms with the pipe character
        ( | ).
    - name: onlyHistoricScope
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: ' Show only historic records'
      defaultValue: "false"
    - name: quoteMode
      description: 'Only lists the size and retail price of the query if you have
        per-domain pricing access purchase : includes the complete list of domain
        names that match the query'
      defaultValue: purchase
    outputs:
    - contextPath: Domain.Name
      description: Name of domain
    description: Reverse lookup of whois information
  - name: whois
    arguments:
    - name: query
      required: true
      default: true
      description: ' (mandatory and default) enter domain (do not use full URL). e.g.
        !whois [query=]demisto.com '
    - name: parsed
      description: Should return parsed or raw response. Default is true
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      defaultValue: "true"
    outputs:
    - contextPath: Domain.Name
      description: Requested domain name
    - contextPath: Domain.Whois
      description: Whois data
    description: Provides registration details about a domain
  - name: whoisHistory
    arguments:
    - name: domain
      required: true
      default: true
      description: Specify domain e.g. mycompany.com
    outputs:
    - contextPath: Domain.Name
      description: Name of domain
    - contextPath: Domain.WhoisHistory
      description: Domain Whois history data
    description: Display a history of whois for a given domain
  - name: domainProfile
    description: Display profile for a given domain
    arguments:
    - name: domain
      description: Specify domain e.g. mycompany.com
