commonfields:
  id: AWS - S3
  version: -1
name: AWS - S3
display: AWS - S3
category: IT Services
image: data:image/png;base64,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
description: AWS - amazon public cloud , S3 service
detaileddescription: |-
  Secret Access Key and Access Key ID can be obtained from IAM page : https://console.aws.amazon.com/iam/.
  Will work only with S3 service.
configuration:
- display: Access Key ID
  name: accesskey
  defaultvalue: ""
  type: 0
  required: true
- display: Secret Access Key
  name: secretkey
  defaultvalue: ""
  type: 4
  required: true
script:
  script: |
    import boto3
    import io
    import math
    from datetime import datetime

    AWS_ACCESS_KEY = demisto.params()['accesskey']
    AWS_SECRET_KEY = demisto.params()['secretkey']

    s3 = boto3.client('s3',aws_access_key_id=AWS_ACCESS_KEY, aws_secret_access_key=AWS_SECRET_KEY)

    def convert_size(size_bytes):
       if size_bytes == 0:
           return "0B"
       size_name = ("B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB")
       i = int(math.floor(math.log(size_bytes, 1024)))
       p = math.pow(1024, i)
       s = round(size_bytes / p, 2)
       return "%s %s" % (s, size_name[i])

    def create_entry(name, data, ec):
        return {
            'ContentsFormat': formats['json'],
            'Type': entryTypes['note'],
            'Contents': data,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(name, data) if data else 'No result were found',
            'EntryContext': ec
        }


    def create_bucket(args):
        data = []
        response = s3.create_bucket(
                        ACL=args.get('acl'),
                        Bucket=args.get('bucketName').lower(),
                        CreateBucketConfiguration={
                            'LocationConstraint': args.get('awsRegion')
                        })
        data.append ({
            'BucketName': args.get('bucketName'),
            'AWSRegion': args.get('awsRegion')
        })

        ec = {'AWS.S3.Bucket': data}
        return create_entry('Created S3 Bucket', data, ec)

    def delete_bucket(args):
        data =[]
        response = s3.delete_bucket(Bucket=args.get('bucketName').lower())

        return "the Bucket %s was Deleted " % args.get('bucketName')

    def list_buckets(args):
        data = []
        response = s3.list_buckets()
        for bucket in response['Buckets']:
            data.append({
                'BucketName': bucket['Name']
            })

        ec = {'AWS.S3.Bucket': data}
        return create_entry('AWS S3 Bucket List', data, ec)

    def get_bucket_policy(args):
        data = []
        response = s3.get_bucket_policy(Bucket=args.get('bucketName'))
        policy = json.loads(response['Policy'])
        statements = policy['Statement']
        for statement in statements:
                data.append({
                    'BucketName':args.get('bucketName'),
                    'PolicyId': policy['Id'],
                    'PolicyVersion': policy['Version'],
                    'Sid': statement['Sid'],
                    'Action': statement['Action'],
                    'Principal': statement['Principal'],
                    'Resource': statement['Resource'],
                    'Effect': statement['Effect']
                    })

        ec = {'AWS.S3.Bucket.Policy': data, 'AWS.S3.Bucket.Policy.json': response['Policy']}
        return create_entry('AWS S3 Bucket Policy', data, ec)

    def set_bucket_policy(args):
        if type(args.get('bucketPolicyJson')) is dict:
            bucket_policy = json.dumps(args.get('bucketPolicyJson'))
        else:
            bucket_policy = args.get('bucketPolicyJson')

        s3.put_bucket_policy(Bucket=args.get('bucketName'), Policy=bucket_policy)
        return 'Successfully applied Bucket policy to %s bucket' % args.get('BucketName')


    def delete_bucket_policy(args):
        s3.delete_bucket_policy(Bucket=args.get('bucketName'))
        return 'Policy deleted from %s' % args.get('bucketName')

    def download_file(args):
        data = io.BytesIO()
        s3.download_fileobj(args.get('bucketName').lower(), args.get('s3Key'), data)

        return fileResult(args.get('s3Key'),data.getvalue())

    def list_objects(args):
        data= []
        for key in s3.list_objects(Bucket=args.get('bucketName'))['Contents']:
            data.append({
                'object': key['Key'],
                'Size': convert_size(key['Size']),
                'LastModified': datetime.strftime(key['LastModified'], '%Y-%m-%dT%H:%M:%S')
            })
        ec = {'AWS.S3.BucketObjects': data}
        return create_entry('AWS S3 Bucket Objects', data, ec)


    # The command demisto.command() holds the command sent from the user.
    if demisto.command() == 'test-module':
        response = s3.list_buckets()
        if response['ResponseMetadata']['HTTPStatusCode'] == 200:
          result = ('ok')

    if demisto.command() == 'aws-s3-create-bucket':
        result = create_bucket(demisto.args())

    if demisto.command() == 'aws-s3-delete-bucket':
        result = delete_bucket(demisto.args())

    if demisto.command() == 'aws-s3-describe-buckets':
        result = list_buckets(demisto.args())

    if demisto.command() == 'aws-s3-get-bucket-policy':
        result = get_bucket_policy(demisto.args())

    if demisto.command() == 'aws-s3-set-bucket-policy':
        result = set_bucket_policy(demisto.args())

    if demisto.command() == 'aws-s3-delete-bucket-policy':
        result = delete_bucket_policy(demisto.args())

    if demisto.command() == 'aws-s3-download-file':
        result = download_file(demisto.args())

    if demisto.command() == 'aws-s3-delete-bucket-policy':
        result = delete_bucket_policy(demisto.args())

    if demisto.command() == 'aws-s3-list-bucket-objects':
        result = list_objects(demisto.args())

    demisto.results(result)
    sys.exit(0)
  type: python
  commands:
  - name: aws-s3-create-bucket
    arguments:
    - name: bucketName
      required: true
      description: The name of S3 bucket to create (in lowercase)
    - name: acl
      required: true
      auto: PREDEFINED
      predefined:
      - private
      - public-read
      - public-read-write
      - authenticated-read
      description: ACL for S3 bucket
      defaultValue: private
    - name: awsRegion
      required: true
      description: AWS Region to create bucket (optional, e.g us-west-1) if no region
        is selected the default region will be used
    outputs:
    - contextPath: AWS.S3.Bucket.BucketName
      description: The name of the bucket that was created
      type: string
    - contextPath: AWS.S3.Bucket.AWSRegion
      description: 'The AWS Region the bucket was created '
      type: string
    description: Create AWS S3 bucket
  - name: aws-s3-delete-bucket
    arguments:
    - name: bucketName
      required: true
      description: Name of S3 bucket to delete
      isArray: true
    outputs:
    - contextPath: AWS.S3.DeletedBuckets.BucketName
      description: Name of S3 bucket that was deleted
      type: string
    description: Delete AWS S3 bucket
  - name: aws-s3-describe-buckets
    arguments: []
    outputs:
    - contextPath: AWS.S3.Bucket.BucketName
      description: The name of the AWS S3 bucket
    description: List all S3 buckets in AWS account
  - name: aws-s3-get-bucket-policy
    arguments:
    - name: bucketName
      required: true
      description: Name of bucket
      isArray: true
    outputs:
    - contextPath: AWS.S3.Bucket.Policy.Version
      description: S3 Bucket Policy Version
      type: string
    - contextPath: AWS.S3.Bucket.Policy.PolicyID
      description: S3 Bucket Policy ID
      type: string
    - contextPath: AWS.S3.Bucket.Policy.Sid
      description: S3 Bucket Policy Statment ID
      type: string
    - contextPath: AWS.S3.Bucket.Policy.Action
      description: S3 Bucket Policy Statment Action
      type: string
    - contextPath: AWS.S3.Bucket.Policy.Principal
      description: S3 Bucket Policy Statment Principal
      type: string
    - contextPath: AWS.S3.Bucket.Policy.Resource
      description: S3 Bucket Policy Statment Resource
      type: string
    - contextPath: AWS.S3.Bucket.Policy.Effect
      description: S3 Bucket Policy Statment Effect
      type: string
    - contextPath: AWS.S3.Bucket.Policy.Json
      description: AWS S3 Policy Json output
      type: string
    - contextPath: AWS.S3.Bucket.Policy.BucketName
      description: S3 Bucket Name
      type: string
    description: Get AWS S3 Bucket Policy
  - name: aws-s3-delete-bucket-policy
    arguments:
    - name: bucketName
      required: true
      description: Name of S3 bucket
    description: Delete AWS S3 Bucket Policy
  - name: aws-s3-download-file
    arguments:
    - name: bucketName
      description: The name of S3 bucket
    - name: s3Key
      description: The S3 object key to download
    description: Download a file from S3 bucket to war room
  - name: aws-s3-list-bucket-objects
    arguments:
    - name: bucketName
      required: true
      description: The name of S3 bucket
    outputs:
    - contextPath: AWS.S3.BucketObjects.Object
      description: The name of S3 object
    - contextPath: AWS.S3.BucketObjects.Size
      description: Object size
    - contextPath: AWS.S3.BucketObjects.LastModified
      description: Last date object was modified
    description: List object in S3 bucket
  - name: aws-s3-set-bucket-policy
    arguments:
    - name: bucketName
      required: true
      description: Name of S3 bucket
    - name: bucketPolicyJson
      required: true
      description: The S3 bucket policy to apply in json  format
    description: Set a new bucket policy from json
  dockerimage: demisto/boto3
  runonce: false
