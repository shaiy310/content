commonfields:
  id: AWS Sagemaker
  version: -1
name: AWS Sagemaker
display: AWS Sagemaker
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: AWS Sagemaker - Demisto Phishing Email Classifier
configuration:
- display: AWS access key
  name: AWSAccessKey
  defaultvalue: ""
  type: 0
  required: true
- display: AWS secret key
  name: AWSSecretKey
  defaultvalue: ""
  type: 4
  required: true
- display: AWS Region code
  name: AWSRegion
  defaultvalue: us-east-2
  type: 0
  required: false
- display: Endpoint Name
  name: EndpointName
  defaultvalue: ""
  type: 0
  required: true
script:
  script: |-
    import json, boto3, sys

    def invoke_enpoint(runtime, endpoint_name, payload):
        return runtime.invoke_endpoint(EndpointName=ENDPOINT_NAME, ContentType='application/json', Body=json.dumps(payload, ensure_ascii=False).encode('utf-8', 'ignore'))

    runtime = boto3.Session(aws_access_key_id=demisto.params()['AWSAccessKey'],
    aws_secret_access_key=demisto.params()['AWSSecretKey'],
    region_name=demisto.params()['AWSRegion']).client('runtime.sagemaker')
    ENDPOINT_NAME = demisto.params()['EndpointName']

    def parse_results(result):
        res = []
        for r in result:
            res.append({
                'Label': r['label'][0],
                'Probability': r['probability']
            })
        return res

    if demisto.command() == 'test-module':
        response = invoke_enpoint(runtime, ENDPOINT_NAME, ["test"])
        if response['ResponseMetadata']['HTTPStatusCode'] == 200:
            demisto.results('ok')
        sys.exit(0)
    if demisto.command() == 'predict-phishing':
        input_text = demisto.args()['inputText']
        if type(input_text) != list:
           input_text = [input_text]
        response = invoke_enpoint(runtime, ENDPOINT_NAME, input_text)
        if response['ResponseMetadata']['HTTPStatusCode'] != 200:
            raise Exception("Failed to invoke enpoint")
        result = json.loads(response['Body'].read().decode())
        predictions = parse_results(result)

        context = {
            "DBotPhishingPrediction": predictions
        }
        demisto.results({
                  'ContentsFormat': formats['json'],
                  'Type': entryTypes['note'],
                  'Contents': predictions,
                  'EntryContext':context,
                  "HumanReadable": tableToMarkdown('DBot label suggestion', predictions),
                  "HumanReadableFormat" : formats["markdown"]
        })
        sys.exit(0)
  type: python
  commands:
  - name: predict-phishing
    arguments:
    - name: inputText
      description: The input text (usually email subject + body)
  dockerimage: demisto/boto3
  runonce: false
releaseNotes: "Add new integration"